.PHONY: dev run build clean fmt test build-all build-windows build-linux build-macos

# å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
dev:
	@echo "ğŸ”¥ å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰..."
	@air

# æ™®é€šè¿è¡Œ
run:
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
	@go run ./cmd/server

# ç¼–è¯‘å½“å‰å¹³å°
build:
	@echo "ğŸ“¦ ç¼–è¯‘é¡¹ç›®..."
	@mkdir -p bin
	@echo "  [1/2] å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
	@rm -rf cmd/server/frontend
	@cp -r ../frontend cmd/server/
	@echo "  [2/2] ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶..."
	@go build -ldflags="-s -w" -o bin/seedmanage ./cmd/server
	@echo "âœ… ç¼–è¯‘å®Œæˆ: bin/seedmanage"

# ç¼–è¯‘æ‰€æœ‰å¹³å°
build-all: build-windows build-linux build-macos
	@echo "âœ… æ‰€æœ‰å¹³å°ç¼–è¯‘å®Œæˆï¼"

# ç¼–è¯‘ Windows
build-windows:
	@echo "ğŸ“¦ ç¼–è¯‘ Windows ç‰ˆæœ¬..."
	@mkdir -p bin
	@echo "  [1/2] å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
	@rm -rf cmd/server/frontend
	@cp -r ../frontend cmd/server/
	@echo "  [2/2] ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶..."
	@GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o bin/seedmanage-windows-amd64.exe ./cmd/server
	@echo "âœ… Windows ç‰ˆæœ¬: bin/seedmanage-windows-amd64.exe"

# ç¼–è¯‘ Linux
build-linux:
	@echo "ğŸ“¦ ç¼–è¯‘ Linux ç‰ˆæœ¬..."
	@mkdir -p bin
	@echo "  [1/2] å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
	@rm -rf cmd/server/frontend
	@cp -r ../frontend cmd/server/
	@echo "  [2/2] ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶..."
	@GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o bin/seedmanage-linux-amd64 ./cmd/server
	@echo "âœ… Linux ç‰ˆæœ¬: bin/seedmanage-linux-amd64"

# ç¼–è¯‘ macOS
build-macos:
	@echo "ğŸ“¦ ç¼–è¯‘ macOS ç‰ˆæœ¬..."
	@mkdir -p bin
	@echo "  [1/3] å¤åˆ¶å‰ç«¯æ–‡ä»¶..."
	@rm -rf cmd/server/frontend
	@cp -r ../frontend cmd/server/
	@echo "  [2/3] ç¼–è¯‘ amd64 ç‰ˆæœ¬..."
	@GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o bin/seedmanage-darwin-amd64 ./cmd/server
	@echo "  [3/3] ç¼–è¯‘ arm64 ç‰ˆæœ¬..."
	@GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o bin/seedmanage-darwin-arm64 ./cmd/server
	@echo "âœ… macOS ç‰ˆæœ¬: bin/seedmanage-darwin-amd64, bin/seedmanage-darwin-arm64"

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "âœ¨ æ ¼å¼åŒ–ä»£ç ..."
	@gofmt -w .
	@goimports -w .

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@go test -v ./...

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	@rm -rf tmp/ bin/ cmd/server/frontend
	@go clean

# å®‰è£…ä¾èµ–å·¥å…·
install-tools:
	@echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·..."
	@go install github.com/air-verse/air@latest
	@go install golang.org/x/tools/cmd/goimports@latest

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo "  make dev           - å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰"
	@echo "  make run           - æ™®é€šè¿è¡Œ"
	@echo "  make build         - ç¼–è¯‘å½“å‰å¹³å°"
	@echo "  make build-all     - ç¼–è¯‘æ‰€æœ‰å¹³å°"
	@echo "  make build-windows - ç¼–è¯‘ Windows ç‰ˆæœ¬"
	@echo "  make build-linux   - ç¼–è¯‘ Linux ç‰ˆæœ¬"
	@echo "  make build-macos   - ç¼–è¯‘ macOS ç‰ˆæœ¬"
	@echo "  make fmt           - æ ¼å¼åŒ–ä»£ç "
	@echo "  make test          - è¿è¡Œæµ‹è¯•"
	@echo "  make clean         - æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@echo "  make install-tools - å®‰è£…å¼€å‘å·¥å…·"

